<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebPrinter 사용 예제</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            line-height: 1.6;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding-bottom: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .header h1 {
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #6b7280;
            font-size: 1.1rem;
        }

        .section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .section h2 {
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .button-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin: 1rem 0;
        }

        .print-button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .print-button:hover {
            background: #1d4ed8;
            transform: translateY(-1px);
        }

        .print-button.secondary {
            background: #6b7280;
        }

        .print-button.secondary:hover {
            background: #4b5563;
        }

        .code-block {
            background: #1f2937;
            color: #f9fafb;
            padding: 1rem;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .warning {
            background: #fef3cd;
            border: 1px solid #fde68a;
            color: #92400e;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .success {
            background: #d1fae5;
            border: 1px solid #a7f3d0;
            color: #065f46;
            padding: 1rem;
            border-radius: 6px;
            margin: 1rem 0;
        }

        .input-group {
            margin: 1rem 0;
        }

        .input-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
        }

        .input-group input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
        }

        .status-display {
            background: #e5e7eb;
            padding: 0.75rem;
            border-radius: 6px;
            font-family: monospace;
            font-size: 0.85rem;
            margin: 1rem 0;
            min-height: 2rem;
        }

        .download-section {
            background: #dbeafe;
            border: 1px solid #93c5fd;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🖨️ WebPrinter 사용 예제</h1>
        <p>웹사이트에서 PDF 파일을 로컬 인쇄 프로그램으로 전송하는 방법</p>
    </div>

    <div class="download-section">
        <h2>📥 먼저 WebPrinter 설치</h2>
        <p>WebPrinter가 설치되어 있지 않다면 아래 링크에서 다운로드하여 설치하세요:</p>
        <div class="button-group">
            <button class="print-button secondary" onclick="alert('실제로는 다운로드 링크가 제공됩니다')">
                💾 Windows용 다운로드
            </button>
            <button class="print-button secondary" onclick="alert('실제로는 다운로드 링크가 제공됩니다')">
                💾 macOS용 다운로드
            </button>
        </div>
    </div>

    <div class="section">
        <h2>🚀 기본 사용법</h2>
        <p>1단계: WebPrinter 실행, 2단계: PDF 파일 업로드</p>
        
        <div class="button-group">
            <button class="print-button" onclick="startWebPrinter()">
                🖨️ WebPrinter 실행
            </button>
            <button class="print-button secondary" onclick="testUrlSend()" disabled id="send-test-btn">
                📤 테스트 URL 전송
            </button>
        </div>

        <div class="code-block">
// 1단계: WebPrinter 실행
&lt;a href="webprinter://print"&gt;🖨️ 인쇄하기&lt;/a&gt;

// 2단계: URL 정보 전송 (JavaScript)
sendUrlsToWebPrinter(serverPort, sessionId, previewUrl, printUrl);
        </div>
    </div>

    <div class="section">
        <h2>🌐 URL 정보 전송 테스트</h2>
        <p>미리보기 및 인쇄할 웹페이지 URL을 WebPrinter로 전송해보세요:</p>
        
        <div class="input-group">
            <label for="preview-url">미리보기용 URL:</label>
            <input type="url" id="preview-url" placeholder="https://www.google.com" value="https://www.google.com">
        </div>
        
        <div class="input-group">
            <label for="print-url">인쇄용 URL:</label>
            <input type="url" id="print-url" placeholder="https://www.naver.com" value="https://www.naver.com">
        </div>
        
        <div class="input-group">
            <label for="paper-width">용지 너비 (mm):</label>
            <input type="number" id="paper-width" value="244" step="0.1" min="10" max="1000">
        </div>
        
        <div class="input-group">
            <label for="paper-height">용지 높이 (mm):</label>
            <input type="number" id="paper-height" value="88" step="0.1" min="10" max="1000">
        </div>
        
        <div class="input-group">
            <label for="paper-size-name">용지 이름:</label>
            <select id="paper-size-name">
                <option value="Custom">커스텀</option>
                <option value="A4">A4 (210×297mm)</option>
                <option value="Letter">Letter (216×279mm)</option>
                <option value="Label">라벨 (244×88mm)</option>
            </select>
        </div>
        
        <div class="button-group">
            <button class="print-button" onclick="sendSelectedUrls()" disabled id="send-urls-btn">
                📤 입력한 URL 전송
            </button>
            <button class="print-button secondary" onclick="sendSampleUrls()">
                🌐 샘플 URL 전송
            </button>
        </div>
        
        <div class="status-display" id="send-status">
            먼저 WebPrinter를 실행하고 URL을 입력하세요.
        </div>
    </div>

    <div class="section">
        <h2>💻 JavaScript로 PDF 업로드</h2>
        <p>JavaScript를 사용하여 PDF 파일을 WebPrinter로 전송하는 방법:</p>
        
        <div class="code-block">
async function uploadPdfsToWebPrinter(port, sessionId, previewPdf, printPdf) {
    const formData = new FormData();
    formData.append('session', sessionId);
    
    if (previewPdf) formData.append('preview_pdf', previewPdf);
    if (printPdf) formData.append('print_pdf', printPdf);
    
    try {
        const response = await fetch(`http://localhost:${port}/upload-pdfs`, {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        if (result.success) {
            console.log('PDF 업로드 성공:', result);
        }
    } catch (error) {
        console.error('PDF 업로드 실패:', error);
    }
}
        </div>
        
        <div class="button-group">
            <button class="print-button" onclick="demonstrateJavaScript()">
                ⚡ JavaScript 업로드 테스트
            </button>
        </div>
    </div>

    <div class="section">
        <h2>🔍 고급 사용법</h2>
        <p>다양한 웹사이트와 콘텐츠 타입을 테스트해보세요:</p>
        
        <div class="button-group">
            <button class="print-button" onclick="printUrl('https://www.wikipedia.org')">
                📖 Wikipedia 인쇄
            </button>
            <button class="print-button" onclick="printUrl('https://stackoverflow.com')">
                💻 Stack Overflow 인쇄
            </button>
            <button class="print-button" onclick="printUrl('https://news.ycombinator.com')">
                📰 Hacker News 인쇄
            </button>
        </div>
    </div>

    <div class="section">
        <h2>⚠️ 주의사항</h2>
        <div class="warning">
            <strong>설치 필요:</strong> WebPrinter가 로컬에 설치되어 있어야 프로토콜 링크가 작동합니다.
        </div>
        <ul>
            <li>WebPrinter가 설치되지 않은 경우 브라우저에서 "알 수 없는 프로토콜" 오류가 발생할 수 있습니다.</li>
            <li>HTTP 서버는 포트 50000-50010 범위에서 자동으로 할당됩니다.</li>
            <li>PDF 파일과 용지 사이즈 정보를 함께 전송해야 합니다.</li>
            <li>244mm×88mm 라벨 용지 등 커스텀 사이즈를 지원합니다.</li>
            <li>HTTPS 페이지에서 localhost HTTP API 호출 시 Mixed Content 정책을 확인하세요.</li>
        </ul>
    </div>

    <div class="section">
        <h2>🛠️ 개발자를 위한 팁</h2>
        <div class="success">
            <strong>프로덕션 사용 시:</strong> 사용자에게 WebPrinter 설치 안내를 제공하세요.
        </div>
        <ul>
            <li>프로토콜 핸들러가 등록되어 있는지 먼저 확인하는 로직을 구현하세요.</li>
            <li>설치되지 않은 경우 다운로드 페이지로 안내하세요.</li>
            <li>오류 처리를 위한 fallback 메커니즘을 준비하세요.</li>
            <li>사용자 경험을 위해 로딩 상태를 표시하세요.</li>
        </ul>
    </div>

    <script>
        // 전역 변수
        let webPrinterInfo = null;

        // WebPrinter 실행
        function startWebPrinter() {
            try {
                const sessionId = generateSessionId();
                const protocolUrl = `webprinter://print?session=${sessionId}`;
                
                const link = document.createElement('a');
                link.href = protocolUrl;
                link.style.display = 'none';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                console.log('WebPrinter 실행:', protocolUrl);
                
                // 서버 정보 확인 (2초 후)
                setTimeout(() => {
                    checkWebPrinterStatus(sessionId);
                }, 2000);
                
            } catch (error) {
                console.error('WebPrinter 실행 실패:', error);
                alert('WebPrinter를 실행할 수 없습니다. 프로그램이 설치되어 있는지 확인하세요.');
            }
        }

        // 세션 ID 생성
        function generateSessionId() {
            return Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        }

        // WebPrinter 서버 상태 확인
        async function checkWebPrinterStatus(sessionId) {
            // 포트 범위에서 서버 찾기 시도 (50000-50010)
            for (let port = 50000; port <= 50010; port++) {
                try {
                    const response = await fetch(`http://localhost:${port}/status`, {
                        method: 'GET',
                        timeout: 1000
                    });
                    
                    if (response.ok) {
                        const status = await response.json();
                        webPrinterInfo = {
                            port: port,
                            session: sessionId,
                            status: 'running'
                        };
                        
                        updateUI();
                        console.log('WebPrinter 서버 발견:', webPrinterInfo);
                        return;
                    }
                } catch (error) {
                    // 계속 시도
                }
            }
            
            alert('WebPrinter 서버를 찾을 수 없습니다. 프로그램이 실행되었는지 확인하세요.');
        }

        // UI 업데이트
        function updateUI() {
            const hasServer = !!webPrinterInfo;
            
            document.getElementById('send-test-btn').disabled = !hasServer;
            document.getElementById('send-urls-btn').disabled = !hasServer;
            
            if (hasServer) {
                document.getElementById('send-status').textContent = 
                    `WebPrinter 연결됨 - 포트: ${webPrinterInfo.port}, 세션: ${webPrinterInfo.session}`;
            }
        }

        // URL 정보 전송
        async function sendUrlsToWebPrinter(port, sessionId, previewUrl, printUrl, paperSize = null) {
            const requestData = {
                session: sessionId,
                preview_url: previewUrl,
                print_url: printUrl
            };
            
            // 용지 사이즈 정보 추가
            if (paperSize) {
                requestData.paper_width = paperSize.width;
                requestData.paper_height = paperSize.height;
                requestData.paper_size = paperSize.name;
            }
            
            try {
                const response = await fetch(`http://localhost:${port}/send-urls`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const result = await response.json();
                if (result.success) {
                    console.log('URL 전송 성공:', result);
                    const paperInfo = result.paperSize ? ` (용지: ${result.paperSize.width}×${result.paperSize.height}mm)` : '';
                    document.getElementById('send-status').textContent = `URL 전송 성공!${paperInfo} WebPrinter에서 확인하세요.`;
                    return true;
                } else {
                    throw new Error(result.error || '전송 실패');
                }
            } catch (error) {
                console.error('URL 전송 실패:', error);
                document.getElementById('send-status').textContent = `전송 실패: ${error.message}`;
                return false;
            }
        }

        // 용지 사이즈 정보 가져오기
        function getPaperSize() {
            const width = parseFloat(document.getElementById('paper-width').value);
            const height = parseFloat(document.getElementById('paper-height').value);
            const name = document.getElementById('paper-size-name').value;
            
            return { width, height, name };
        }

        // 선택한 URL 전송
        async function sendSelectedUrls() {
            if (!webPrinterInfo) {
                alert('먼저 WebPrinter를 실행하세요.');
                return;
            }

            const previewUrl = document.getElementById('preview-url').value.trim();
            const printUrl = document.getElementById('print-url').value.trim();

            if (!previewUrl && !printUrl) {
                alert('최소 하나의 URL을 입력하세요.');
                return;
            }

            const paperSize = getPaperSize();
            document.getElementById('send-status').textContent = 'URL 전송 중...';
            
            const success = await sendUrlsToWebPrinter(
                webPrinterInfo.port,
                webPrinterInfo.session,
                previewUrl,
                printUrl,
                paperSize
            );
        }

        // 테스트 URL 전송
        async function testUrlSend() {
            if (!webPrinterInfo) {
                alert('먼저 WebPrinter를 실행하세요.');
                return;
            }

            // 테스트용 URL
            const testPreviewUrl = 'https://www.google.com';
            const testPrintUrl = 'https://www.naver.com';
            const paperSize = getPaperSize();
            
            document.getElementById('send-status').textContent = '테스트 URL 전송 중...';
            
            const success = await sendUrlsToWebPrinter(
                webPrinterInfo.port,
                webPrinterInfo.session,
                testPreviewUrl, // 미리보기용
                testPrintUrl,   // 인쇄용
                paperSize
            );
        }

        // 샘플 URL 전송
        async function sendSampleUrls() {
            if (!webPrinterInfo) {
                alert('먼저 WebPrinter를 실행하세요.');
                return;
            }
            
            // 샘플 URL들
            const samplePreviewUrl = 'https://www.google.com';
            const samplePrintUrl = 'https://www.naver.com';
            const paperSize = { width: 244, height: 88, name: 'Label' };
            
            document.getElementById('send-status').textContent = '샘플 URL 전송 중...';
            
            const success = await sendUrlsToWebPrinter(
                webPrinterInfo.port,
                webPrinterInfo.session,
                samplePreviewUrl,
                samplePrintUrl,
                paperSize
            );
        }

        // JavaScript 방식 데모
        async function demonstrateJavaScript() {
            if (!webPrinterInfo) {
                alert('먼저 WebPrinter를 실행하세요.');
                return;
            }
            
            await testUrlSend();
        }

        // 용지 사이즈 프리셋 설정
        function setPaperSizePreset() {
            const sizeSelect = document.getElementById('paper-size-name');
            const widthInput = document.getElementById('paper-width');
            const heightInput = document.getElementById('paper-height');
            
            const presets = {
                'A4': { width: 210, height: 297 },
                'Letter': { width: 216, height: 279 },
                'Label': { width: 244, height: 88 },
                'Custom': null
            };
            
            const selectedPreset = presets[sizeSelect.value];
            if (selectedPreset) {
                widthInput.value = selectedPreset.width;
                heightInput.value = selectedPreset.height;
            }
        }

        // URL 입력 시 UI 업데이트
        document.addEventListener('DOMContentLoaded', () => {
            const previewInput = document.getElementById('preview-url');
            const printInput = document.getElementById('print-url');
            const sizeSelect = document.getElementById('paper-size-name');
            
            // URL 입력 이벤트
            [previewInput, printInput].forEach(input => {
                input.addEventListener('input', () => {
                    const hasUrls = previewInput.value.trim() || printInput.value.trim();
                    const hasServer = !!webPrinterInfo;
                    document.getElementById('send-urls-btn').disabled = !hasUrls || !hasServer;
                });
            });
            
            // 용지 사이즈 프리셋 변경 이벤트
            sizeSelect.addEventListener('change', setPaperSizePreset);
        });
    </script>
</body>
</html> 