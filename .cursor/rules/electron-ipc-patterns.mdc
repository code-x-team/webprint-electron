---
globs: *.js,preload.js,main.js,modules/**/*.js,renderer/**/*.js
---
# Electron IPC í†µì‹  íŒ¨í„´

## IPC ì±„ë„ ëª…ëª… ê·œì¹™

### 1. ëª…ë ¹í˜• ì±„ë„ (Main â†’ Renderer)
```javascript
// âœ… ì¢‹ì€ ì˜ˆ - ë™ì‘ì„ ì„¤ëª…í•˜ëŠ” ëª…í™•í•œ ì´ë¦„
'server-info'        // ì„œë²„ ì •ë³´ ì „ë‹¬
'urls-received'      // URL ë°ì´í„° ìˆ˜ì‹ 
'session-changed'    // ì„¸ì…˜ ë³€ê²½ ì•Œë¦¼
'loading-complete'   // ë¡œë”© ì™„ë£Œ ì•Œë¦¼

// âŒ ë‚˜ìœ ì˜ˆ - ë¶ˆëª…í™•í•œ ì´ë¦„
'data'
'update'
'message'
```

### 2. ìš”ì²­/ì‘ë‹µ ì±„ë„ (Renderer â†’ Main)
```javascript
// âœ… ì¢‹ì€ ì˜ˆ - ë™ì‚¬-ëª…ì‚¬ í˜•ì‹
'get-printers'       // í”„ë¦°í„° ëª©ë¡ ìš”ì²­
'print-url'          // URL ì¸ì‡„ ì‹¤í–‰
'get-server-info'    // ì„œë²„ ì •ë³´ ìš”ì²­
'hide-to-background' // ë°±ê·¸ë¼ìš´ë“œë¡œ ìˆ¨ê¸°ê¸°

// âŒ ë‚˜ìœ ì˜ˆ
'printers'
'print'
'server'
```

## Preload ìŠ¤í¬ë¦½íŠ¸ íŒ¨í„´

### contextBridge ë…¸ì¶œ êµ¬ì¡°
```javascript
// âœ… í‘œì¤€ íŒ¨í„´ (preload.js)
const { contextBridge, ipcRenderer } = require('electron');

contextBridge.exposeInMainWorld('electronAPI', {
  // ë‹¨ë°©í–¥ í†µì‹  (invoke)
  getPrinters: () => ipcRenderer.invoke('get-printers'),
  printUrl: (options) => ipcRenderer.invoke('print-url', options),
  
  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  onServerInfo: (callback) => {
    ipcRenderer.on('server-info', (event, info) => callback(info));
  },
  
  onUrlsReceived: (callback) => {
    ipcRenderer.on('urls-received', (event, urlData) => callback(urlData));
  }
});
```

## Main Process IPC í•¸ë“¤ëŸ¬

### ipcMain.handle íŒ¨í„´
```javascript
// âœ… í‘œì¤€ ë¹„ë™ê¸° í•¸ë“¤ëŸ¬
ipcMain.handle('get-printers', async (event) => {
  console.log('get-printers IPC í˜¸ì¶œë¨');
  
  try {
    const printers = await someAsyncOperation();
    
    return { 
      success: true, 
      printers: printers,
      totalCount: printers.length
    };
  } catch (error) {
    console.error('í”„ë¦°í„° ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
    return { 
      success: false, 
      error: error.message, 
      printers: [] 
    };
  }
});
```

### íŒŒë¼ë¯¸í„° ê²€ì¦
```javascript
// âœ… íŒŒë¼ë¯¸í„° ê²€ì¦ í¬í•¨
ipcMain.handle('print-url', async (event, params) => {
  // 1. íŒŒë¼ë¯¸í„° ì¡´ì¬ í™•ì¸
  if (!params) {
    return { success: false, error: 'íŒŒë¼ë¯¸í„°ê°€ ì—†ìŠµë‹ˆë‹¤' };
  }
  
  // 2. í•„ìˆ˜ í•„ë“œ ê²€ì¦
  if (!params.url) {
    return { success: false, error: 'URLì´ í•„ìš”í•©ë‹ˆë‹¤' };
  }
  
  // 3. íƒ€ì… ê²€ì¦
  if (typeof params.copies !== 'number' || params.copies < 1) {
    params.copies = 1; // ê¸°ë³¸ê°’ ì„¤ì •
  }
  
  // 4. ë©”ì¸ ë¡œì§
  try {
    const result = await executePrint(params);
    return result;
  } catch (error) {
    return { success: false, error: error.message };
  }
});
```

## Renderer Process IPC ì‚¬ìš©

### IPCHandler ëª¨ë“ˆ íŒ¨í„´
```javascript
// âœ… ì¤‘ì•™ì§‘ì¤‘ì‹ IPC ê´€ë¦¬ (renderer/ipc-handler.js)
const IPCHandler = {
  async getPrinters() {
    console.log('getPrinters ìš”ì²­ ì‹œì‘');
    
    if (!window.electronAPI) {
      throw new Error('Electron APIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    try {
      const result = await window.electronAPI.getPrinters();
      console.log('getPrinters ì‘ë‹µ:', result);
      
      if (!result.success) {
        throw new Error(result.error || 'í”„ë¦°í„° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨');
      }
      
      return result;
    } catch (error) {
      console.error('í”„ë¦°í„° ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:', error);
      throw error;
    }
  }
};
```

### ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
```javascript
// âœ… ì´ˆê¸°í™” ì‹œ ì´ë²¤íŠ¸ ì„¤ì •
function setupListeners() {
  if (!window.electronAPI) {
    console.error('Electron API not available');
    return;
  }

  // ì„œë²„ ì •ë³´ ìˆ˜ì‹ 
  window.electronAPI.onServerInfo((info) => {
    console.log('onServerInfo ì´ë²¤íŠ¸ ìˆ˜ì‹ :', info);
    handleServerInfo(info);
  });

  // URL ë°ì´í„° ìˆ˜ì‹ 
  window.electronAPI.onUrlsReceived((urlData) => {
    console.log('onUrlsReceived ì´ë²¤íŠ¸ ìˆ˜ì‹ :', urlData);
    handleUrlsReceived(urlData);
  });
}
```

## ì–‘ë°©í–¥ í†µì‹  íŒ¨í„´

### Mainì—ì„œ Rendererë¡œ ë°ì´í„° ì „ì†¡
```javascript
// Main Process
function notifyWindow(sessionId, urlData) {
  if (printWindow && !printWindow.isDestroyed()) {
    printWindow.webContents.send('urls-received', urlData);
  }
}

// Renderer Process (via preload)
window.electronAPI.onUrlsReceived((urlData) => {
  // ë°ì´í„° ì²˜ë¦¬
});
```

### ìƒíƒœ ë™ê¸°í™”
```javascript
// âœ… ì„¸ì…˜ ë³€ê²½ ì‹œ ë™ê¸°í™”
// Main Process
currentSession = newSessionId;
printWindow.webContents.send('session-changed', { 
  session: newSessionId,
  timestamp: Date.now()
});

// Renderer Process
window.electronAPI.onSessionChanged((data) => {
  console.log('ìƒˆ ì„¸ì…˜:', data.session);
  updateUIForNewSession(data.session);
});
```

## ì—ëŸ¬ ì²˜ë¦¬ ë° ë³µêµ¬

### IPC í†µì‹  ëª¨ë‹ˆí„°ë§
```javascript
// âœ… ì—°ê²° ìƒíƒœ ì£¼ê¸°ì  í™•ì¸
let consecutiveFailures = 0;

setInterval(async () => {
  try {
    await window.electronAPI.getAppVersion();
    consecutiveFailures = 0;
  } catch (error) {
    consecutiveFailures++;
    
    if (consecutiveFailures >= 3) {
      console.error('IPC í†µì‹  ì‹¤íŒ¨');
      attemptRecovery();
    }
  }
}, 10000);
```

### í†µì‹  ì‹¤íŒ¨ ì‹œ ë³µêµ¬
```javascript
// âœ… ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜
async function attemptRecovery() {
  try {
    // 1. ì„œë²„ ì •ë³´ ì¬ìš”ì²­
    const info = await window.electronAPI.getServerInfo();
    if (info) {
      showToast('âœ… ì—°ê²° ë³µêµ¬ë¨', 'success');
      return;
    }
  } catch (error) {
    // 2. ë³µêµ¬ ì‹¤íŒ¨ ì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    showToast('ğŸ”„ í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤...', 'info');
    setTimeout(() => window.location.reload(), 2000);
  }
}
```

## ë³´ì•ˆ ê³ ë ¤ì‚¬í•­

### 1. Context Isolation í•„ìˆ˜
```javascript
// âœ… webPreferences ì„¤ì •
webPreferences: {
  nodeIntegration: false,    // Node.js í†µí•© ë¹„í™œì„±í™”
  contextIsolation: true,    // ì»¨í…ìŠ¤íŠ¸ ê²©ë¦¬ í™œì„±í™”
  preload: path.join(__dirname, 'preload.js')
}
```

### 2. í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ë°©ì‹
```javascript
// âœ… ëª…ì‹œì ìœ¼ë¡œ í—ˆìš©ëœ ì±„ë„ë§Œ ë…¸ì¶œ
const ALLOWED_CHANNELS = [
  'get-printers',
  'print-url',
  'get-server-info'
];

// ì±„ë„ ê²€ì¦
if (!ALLOWED_CHANNELS.includes(channel)) {
  throw new Error('í—ˆìš©ë˜ì§€ ì•Šì€ ì±„ë„');
}
```