---
description:
globs:
alwaysApply: false
---
# IPC í†µì‹  ë””ë²„ê¹… ê°€ì´ë“œ

## ê°œìš”
WebPrinterì˜ IPC(Inter-Process Communication) í†µì‹  ìƒíƒœë¥¼ ì ê²€í•˜ê³  ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ì„ ì•ˆë‚´í•©ë‹ˆë‹¤.

## IPC í†µì‹  êµ¬ì¡°

### ì£¼ìš” IPC ì±„ë„
- **Invoke ì±„ë„**: `get-printers`, `print-url`, `get-server-info`, `hide-to-background`
- **Event ì±„ë„**: `urls-received`, `server-info`, `session-restored`, `update-available`

### í†µì‹  íë¦„
```
ì›¹í˜ì´ì§€ â†’ HTTP Server â†’ main.js â†’ IPC â†’ preload.js â†’ print-preview.js
```

## ìë™ IPC ìƒíƒœ ì ê²€ ì‹œìŠ¤í…œ

### checkIpcCommunication() í•¨ìˆ˜
[print-preview.js](mdc:print-preview.js)ì—ì„œ 6ë‹¨ê³„ ì ê²€ ìˆ˜í–‰:

```javascript
const checks = {
    electronAPI: false,        // 1. electronAPI ê°ì²´ ì¡´ì¬ í™•ì¸
    getServerInfo: false,      // 2. ì„œë²„ ì •ë³´ API í…ŒìŠ¤íŠ¸
    getPrinters: false,        // 3. í”„ë¦°í„° ëª©ë¡ API í…ŒìŠ¤íŠ¸
    getAppVersion: false,      // 4. ì•± ë²„ì „ API í…ŒìŠ¤íŠ¸
    printUrl: false,           // 5. printUrl í•¨ìˆ˜ ì¡´ì¬ í™•ì¸
    eventListeners: false      // 6. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ë“¤ í™•ì¸
};
```

### ì ê²€ ê²°ê³¼ í•´ì„
- **100%**: âœ… IPC í†µì‹  ì •ìƒ ì‘ë™
- **70% ì´ìƒ**: âš ï¸ IPC í†µì‹  ë¶€ë¶„ ì‘ë™
- **70% ë¯¸ë§Œ**: âŒ IPC í†µì‹  ì‹¬ê°í•œ ë¬¸ì œ

## ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ

### startIpcMonitoring() í•¨ìˆ˜
```javascript
// 10ì´ˆë§ˆë‹¤ IPC ì—°ê²° ìƒíƒœ ì²´í¬
setInterval(async () => {
    try {
        await window.electronAPI.getAppVersion();
        consecutiveFailures = 0;
    } catch (error) {
        consecutiveFailures++;
        if (consecutiveFailures >= 3) {
            // 3íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ ë³µêµ¬ ì‹œë„
            attemptIpcRecovery();
        }
    }
}, 10000);
```

### ìë™ ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜
```javascript
async function attemptIpcRecovery() {
    // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ìœ¼ë¡œ IPC ì¬ì—°ê²° ì‹œë„
    setTimeout(() => {
        window.location.reload();
    }, 3000);
}
```

## ë””ë²„ê¹… ë„êµ¬

### ì½˜ì†” ë¡œê·¸ ë¶„ì„
IPC í†µì‹  ê³¼ì •ì—ì„œ ì¶œë ¥ë˜ëŠ” ì£¼ìš” ë¡œê·¸ë“¤:

```javascript
// ì„±ê³µì ì¸ IPC í†µì‹ 
âœ… electronAPI ê°ì²´ ì¡´ì¬ í™•ì¸
âœ… getServerInfo API ì •ìƒ
âœ… getPrinters API ì •ìƒ
âœ… ëª¨ë“  IPC í†µì‹  í…ŒìŠ¤íŠ¸ í†µê³¼!

// ì‹¤íŒ¨í•œ IPC í†µì‹ 
âŒ electronAPI ê°ì²´ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤
âŒ getServerInfo API ì‹¤íŒ¨: Error message
âŒ IPC í†µì‹ ì— ì‹¬ê°í•œ ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤
```

### IPC ë©”ì‹œì§€ ì „ì†¡ í™•ì¸
[main.js](mdc:main.js)ì—ì„œ ì‹¤ì‹œê°„ IPC ì „ì†¡ ìƒíƒœ:

```javascript
console.log(`ğŸ” ì‹¤ì‹œê°„ IPC ì „ì†¡ ì¡°ê±´ í™•ì¸:`);
console.log(`- printWindow ì¡´ì¬: ${!!printWindow}`);
console.log(`- currentSession: ${currentSession}`);
console.log(`- ìš”ì²­ sessionId: ${sessionId}`);
console.log(`- ì„¸ì…˜ ì¼ì¹˜: ${currentSession === sessionId}`);
```

## ì¼ë°˜ì ì¸ ë¬¸ì œ ë° í•´ê²°ë°©ë²•

### 1. electronAPI ê°ì²´ ì—†ìŒ
**ì¦ìƒ**: `âŒ IPC í†µì‹  ì‹¤íŒ¨: electronAPI ê°ì²´ ì—†ìŒ`

**ì›ì¸**: 
- [preload.js](mdc:preload.js) ë¡œë”© ì‹¤íŒ¨
- Context isolation ì„¤ì • ë¬¸ì œ

**í•´ê²°ë°©ë²•**:
```javascript
// main.jsì—ì„œ webPreferences í™•ì¸
webPreferences: {
    nodeIntegration: false,
    contextIsolation: true,
    preload: path.join(__dirname, 'preload.js')
}
```

### 2. IPC ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨
**ì¦ìƒ**: `âš ï¸ IPC ë©”ì‹œì§€ ì „ì†¡ ì¡°ê±´ ë¶ˆì¶©ì¡±`

**ì›ì¸**:
- printWindowê°€ destroy ìƒíƒœ
- ì„¸ì…˜ ID ë¶ˆì¼ì¹˜
- ë Œë”ëŸ¬ ë¡œë”© ì¤‘

**í•´ê²°ë°©ë²•**:
```javascript
// ì•ˆì „í•œ IPC ì „ì†¡ íŒ¨í„´
if (printWindow && !printWindow.isDestroyed() && currentSession === sessionId) {
    if (printWindow.webContents.isLoading()) {
        printWindow.webContents.once('did-finish-load', () => {
            setTimeout(() => {
                printWindow.webContents.send('urls-received', urlData);
            }, 500);
        });
    } else {
        printWindow.webContents.send('urls-received', urlData);
    }
}
```

### 3. API í˜¸ì¶œ íƒ€ì„ì•„ì›ƒ
**ì¦ìƒ**: `âŒ getServerInfo API ì‹¤íŒ¨: Timeout`

**ì›ì¸**:
- ë©”ì¸ í”„ë¡œì„¸ìŠ¤ ë¸”ë¡œí‚¹
- IPC ì±„ë„ í˜¼ì¡

**í•´ê²°ë°©ë²•**:
```javascript
// Promise.raceë¡œ íƒ€ì„ì•„ì›ƒ ì„¤ì •
const timeoutPromise = new Promise((_, reject) => 
    setTimeout(() => reject(new Error('API Timeout')), 5000)
);

try {
    const result = await Promise.race([
        window.electronAPI.getServerInfo(),
        timeoutPromise
    ]);
} catch (error) {
    console.error('API í˜¸ì¶œ ì‹¤íŒ¨:', error);
}
```

## í”„ë¡œë•ì…˜ í™˜ê²½ ëª¨ë‹ˆí„°ë§

### ì—ëŸ¬ ìˆ˜ì§‘
```javascript
window.addEventListener('unhandledrejection', (event) => {
    console.error('ë¯¸ì²˜ë¦¬ Promise ê±°ë¶€:', event.reason);
    if (event.reason.message.includes('IPC')) {
        // IPC ê´€ë ¨ ì—ëŸ¬ íŠ¹ë³„ ì²˜ë¦¬
        attemptIpcRecovery();
    }
});
```

### ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§
```javascript
// IPC í˜¸ì¶œ ì„±ëŠ¥ ì¸¡ì •
const startTime = performance.now();
await window.electronAPI.printUrl(options);
const endTime = performance.now();
console.log(`ì¸ì‡„ API í˜¸ì¶œ ì‹œê°„: ${endTime - startTime}ms`);
```

## ë² ìŠ¤íŠ¸ í”„ë™í‹°ìŠ¤

### 1. ì•ˆì „í•œ IPC í˜¸ì¶œ
```javascript
// í•­ìƒ electronAPI ì¡´ì¬ í™•ì¸
if (typeof window.electronAPI === 'object' && window.electronAPI !== null) {
    try {
        const result = await window.electronAPI.someMethod();
    } catch (error) {
        console.error('IPC í˜¸ì¶œ ì‹¤íŒ¨:', error);
    }
} else {
    console.error('electronAPIë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
}
```

### 2. ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
```javascript
// ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
const removeListener = window.electronAPI.onUrlsReceived((data) => {
    // ì²˜ë¦¬ ë¡œì§
});

// ì •ë¦¬ ì‹œ
removeListener();
```

### 3. ì—ëŸ¬ ë³µêµ¬ ì „ëµ
```javascript
// ë‹¨ê³„ì  ë³µêµ¬ ì‹œë„
async function gracefulIpcRecovery() {
    // 1ë‹¨ê³„: ê°„ë‹¨í•œ API ì¬ì‹œë„
    try {
        await window.electronAPI.getAppVersion();
        return true;
    } catch (error) {
        console.warn('1ë‹¨ê³„ ë³µêµ¬ ì‹¤íŒ¨:', error);
    }
    
    // 2ë‹¨ê³„: í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    try {
        window.location.reload();
        return true;
    } catch (error) {
        console.error('2ë‹¨ê³„ ë³µêµ¬ ì‹¤íŒ¨:', error);
    }
    
    // 3ë‹¨ê³„: ì‚¬ìš©ìì—ê²Œ ì•± ì¬ì‹œì‘ ìš”ì²­
    alert('ì‹œìŠ¤í…œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì•±ì„ ë‹¤ì‹œ ì‹œì‘í•´ì£¼ì„¸ìš”.');
    return false;
}
```
