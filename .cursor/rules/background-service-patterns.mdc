---
globs: main.js,modules/**/*.js
---
# ë°±ê·¸ë¼ìš´ë“œ ì„œë¹„ìŠ¤ íŒ¨í„´

## ë¶ˆì‚¬ì¡° ëª¨ë“œ (ì¢…ë£Œ ë°©ì§€)

### ì¢…ë£Œ ì´ë²¤íŠ¸ ì°¨ë‹¨
```javascript
// âœ… before-quit ì´ë²¤íŠ¸ë¡œ ì¢…ë£Œ ë°©ì§€
app.on('before-quit', (event) => {
  if (!allowQuit && !global.isQuitting) {
    console.log('ğŸ”¥ ì¢…ë£Œ ë°©ì§€: ë°±ê·¸ë¼ìš´ë“œë¡œ ì „í™˜');
    event.preventDefault();
    
    // ëª¨ë“  ì°½ ìˆ¨ê¸°ê¸°
    BrowserWindow.getAllWindows().forEach(window => {
      if (window && !window.isDestroyed()) {
        window.hide();
      }
    });
    
    // macOS dock ìˆ¨ê¸°ê¸°
    if (process.platform === 'darwin' && app.dock) {
      app.dock.hide();
    }
  }
});
```

### ì°½ ë‹«ê¸° ì²˜ë¦¬
```javascript
// âœ… ì°½ ë‹«ê¸° ì‹œ ìˆ¨ê¸°ê¸°ë¡œ ëŒ€ì²´
printWindow.on('close', (event) => {
  if (!global.isQuitting) {
    event.preventDefault();
    printWindow.hide();
    
    // macOS Dock ì•„ì´ì½˜ ìˆ¨ê¸°ê¸°
    if (process.platform === 'darwin' && app.dock) {
      app.dock.hide();
    }
  }
});
```

## ìë™ ì‹œì‘ ì„¤ì •

### í¬ë¡œìŠ¤ í”Œë«í¼ ìë™ ì‹œì‘
```javascript
// âœ… í”Œë«í¼ë³„ ìë™ ì‹œì‘ ì„¤ì •
function setupAutoLaunch() {
  // Electron API ì‚¬ìš© (í¬ë¡œìŠ¤ í”Œë«í¼)
  app.setLoginItemSettings({
    openAtLogin: true,
    openAsHidden: true,
    name: 'WebPrinter',
    args: ['--hidden', '--startup']
  });
  
  // Windows ì „ìš© ì¶”ê°€ ì„¤ì •
  if (process.platform === 'win32') {
    try {
      // ë ˆì§€ìŠ¤íŠ¸ë¦¬ ë“±ë¡
      const startupArgs = `"${process.execPath}" --hidden --startup`;
      execSync(`reg add "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" /v "WebPrinter" /d "${startupArgs}" /f`, 
        { windowsHide: true }
      );
      
      // ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ë°±ì—…
      execSync(`schtasks /create /tn "WebPrinter" /tr "${startupArgs}" /sc onlogon /f /rl highest`, 
        { windowsHide: true }
      );
    } catch (error) {
      console.log('âš ï¸ Windows ì‹œì‘ í”„ë¡œê·¸ë¨ ë“±ë¡ ì‹¤íŒ¨:', error.message);
    }
  }
}
```

## ì„œë¹„ìŠ¤ ê°ì‹œ ë° ë³µêµ¬

### ê°ì‹œì(Watchdog) íŒ¨í„´
```javascript
// âœ… ì£¼ê¸°ì  ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
let watchdogTimer = null;

function startWatchdog() {
  if (watchdogTimer) {
    clearInterval(watchdogTimer);
  }
  
  watchdogTimer = setInterval(() => {
    if (!allowQuit && !global.isQuitting) {
      // í•µì‹¬ ì„œë¹„ìŠ¤ í™•ì¸
      if (!server || !tray || tray.isDestroyed()) {
        console.log('ğŸ”„ í•µì‹¬ ì„œë¹„ìŠ¤ ë³µêµ¬ ì¤‘...');
        restoreServices();
      }
    }
  }, 5000); // 5ì´ˆë§ˆë‹¤ ì²´í¬
}
```

### ì„œë¹„ìŠ¤ ë³µêµ¬
```javascript
// âœ… ì„œë¹„ìŠ¤ ë³µêµ¬ í•¨ìˆ˜
function restoreServices() {
  try {
    // HTTP ì„œë²„ ë³µêµ¬
    if (!server) {
      const httpServer = startHttpServer();
      if (httpServer) {
        server = httpServer;
        console.log('âœ… HTTP ì„œë²„ ë³µêµ¬ë¨');
      }
    }
    
    // ì‹œìŠ¤í…œ íŠ¸ë ˆì´ ë³µêµ¬
    if (!tray || tray.isDestroyed()) {
      createTray();
      console.log('âœ… íŠ¸ë ˆì´ ë³µêµ¬ë¨');
    }
    
    // IPC í•¸ë“¤ëŸ¬ ì¬ì„¤ì •
    try {
      setupIpcHandlers();
      console.log('âœ… IPC í•¸ë“¤ëŸ¬ ë³µêµ¬ë¨');
    } catch (error) {
      console.log('âš ï¸ IPC í•¸ë“¤ëŸ¬ ë³µêµ¬ ì‹¤íŒ¨:', error.message);
    }
  } catch (error) {
    console.error('âŒ ì„œë¹„ìŠ¤ ë³µêµ¬ ì‹¤íŒ¨:', error);
  }
}
```

## ì—ëŸ¬ ë³µêµ¬ ì‹œìŠ¤í…œ

### ì „ì—­ ì—ëŸ¬ í•¸ë“¤ë§
```javascript
// âœ… ì˜ˆìƒì¹˜ ëª»í•œ ì—ëŸ¬ ì²˜ë¦¬
process.on('uncaughtException', (error) => {
  console.error('ğŸš¨ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜:', error);
  
  if (!global.isQuitting && !allowQuit) {
    console.log('ğŸ”„ ì˜¤ë¥˜ ë³µêµ¬ ì‹œë„...');
    
    // 3ì´ˆ í›„ ì„œë¹„ìŠ¤ ë³µêµ¬
    setTimeout(() => {
      try {
        restoreServices();
      } catch (restoreError) {
        console.error('âŒ ë³µêµ¬ ì‹¤íŒ¨:', restoreError);
      }
    }, 3000);
  }
});

// Promise ê±°ë¶€ ì²˜ë¦¬
process.on('unhandledRejection', (reason, promise) => {
  console.error('ğŸš¨ ì²˜ë¦¬ë˜ì§€ ì•Šì€ Promise ê±°ë¶€:', reason);
  // ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ê³„ì† ì‹¤í–‰
});
```

## ì‹œìŠ¤í…œ íŠ¸ë ˆì´ ê´€ë¦¬

### íŠ¸ë ˆì´ ìƒì„± ë° ë©”ë‰´
```javascript
// âœ… ì‹œìŠ¤í…œ íŠ¸ë ˆì´ ì„¤ì •
function createTray() {
  try {
    const iconPath = path.join(__dirname, 
      process.platform === 'win32' ? 'assets/icon-32.png' : 'assets/icon.png'
    );
    
    tray = new Tray(iconPath);
    
    const contextMenu = Menu.buildFromTemplate([
      {
        label: 'ğŸ“‹ WebPrinter ìƒíƒœ',
        enabled: false
      },
      {
        label: 'âœ… ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘',
        enabled: false
      },
      { type: 'separator' },
      {
        label: 'ğŸ”„ ì¬ì‹œì‘',
        click: () => {
          allowQuit = true;
          global.isQuitting = true;
          app.relaunch();
          app.quit();
        }
      },
      {
        label: 'ğŸ›‘ ì™„ì „ ì¢…ë£Œ',
        click: () => {
          allowQuit = true;
          global.isQuitting = true;
          
          // ì •ë¦¬ ì‘ì—…
          if (watchdogTimer) {
            clearInterval(watchdogTimer);
          }
          stopHttpServer();
          app.quit();
        }
      }
    ]);
    
    tray.setToolTip('WebPrinter - ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ ì¤‘');
    tray.setContextMenu(contextMenu);
  } catch (error) {
    console.error('íŠ¸ë ˆì´ ìƒì„± ì‹¤íŒ¨:', error);
  }
}
```

## HTTP ì„œë²„ ê´€ë¦¬

### í¬íŠ¸ ìë™ í• ë‹¹
```javascript
// âœ… ì‚¬ìš© ê°€ëŠ¥í•œ í¬íŠ¸ ì°¾ê¸°
async function startHttpServer() {
  const tryPort = async (port) => {
    const server = app.listen(port, 'localhost', () => {
      serverPort = server.address().port;
      httpServer = server;
      console.log(`HTTP ì„œë²„ê°€ í¬íŠ¸ ${serverPort}ì—ì„œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.`);
      resolve(server);
    });
    
    server.on('error', async (err) => {
      if (err.code === 'EADDRINUSE' && port < 18740) {
        // ë‹¤ìŒ í¬íŠ¸ ì‹œë„
        console.log(`í¬íŠ¸ ${port}ê°€ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤. ë‹¤ìŒ í¬íŠ¸ë¥¼ ì‹œë„í•©ë‹ˆë‹¤...`);
        await tryPort(port + 1);
      } else {
        reject(err);
      }
    });
  };
  
  return tryPort(18731);
}
```

## ì„¸ì…˜ ë°ì´í„° ì˜ì†ì„±

### ì„¸ì…˜ ì €ì¥ ë° ë³µêµ¬
```javascript
// âœ… íŒŒì¼ ì‹œìŠ¤í…œ ê¸°ë°˜ ì„¸ì…˜ ì €ì¥
const sessionDataPath = path.join(os.homedir(), '.webprinter-sessions.json');

function saveSessionData() {
  try {
    fs.writeFileSync(sessionDataPath, JSON.stringify({
      lastSaved: new Date().toISOString(),
      receivedUrls: receivedUrls
    }, null, 2));
  } catch (error) {
    console.error('ì„¸ì…˜ ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
  }
}

function loadSessionData() {
  try {
    if (!fs.existsSync(sessionDataPath)) return;
    
    const data = JSON.parse(fs.readFileSync(sessionDataPath, 'utf8'));
    const hoursDiff = (new Date() - new Date(data.lastSaved)) / (1000 * 60 * 60);
    
    // 24ì‹œê°„ ì´ë‚´ ë°ì´í„°ë§Œ ë³µêµ¬
    if (hoursDiff <= 24) {
      receivedUrls = data.receivedUrls || {};
      console.log(`${Object.keys(receivedUrls).length}ê°œì˜ ì„¸ì…˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
    }
  } catch (error) {
    console.error('ì„¸ì…˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
  }
}
```

## í”„ë¡œí† ì½œ í•¸ë“¤ë§

### ì»¤ìŠ¤í…€ í”„ë¡œí† ì½œ ë“±ë¡
```javascript
// âœ… webprinter:// í”„ë¡œí† ì½œ ì²˜ë¦¬
function registerProtocol() {
  const protocolName = 'webprinter';
  
  if (process.defaultApp) {
    app.setAsDefaultProtocolClient(protocolName, 
      process.execPath, 
      [path.resolve(process.argv[1])]
    );
  } else {
    app.setAsDefaultProtocolClient(protocolName);
  }
}

// í”„ë¡œí† ì½œ í˜¸ì¶œ ì²˜ë¦¬
app.on('open-url', (event, url) => {
  event.preventDefault();
  handleProtocolCall(url);
});
```

## ì‹œì‘ ëª¨ë“œ ì²˜ë¦¬

### ë°±ê·¸ë¼ìš´ë“œ ì‹œì‘
```javascript
// âœ… ì‹œì‘ ì¸ìˆ˜ í™•ì¸
const isStartupLaunch = process.argv.includes('--startup');
const isHidden = process.argv.includes('--hidden');

if (isHidden || isStartupLaunch) {
  console.log('ğŸ”• ë°±ê·¸ë¼ìš´ë“œ ëª¨ë“œ í™œì„±í™”ë¨');
  global.startupMode = true;
  
  // ì°½ì„ ì—´ì§€ ì•Šê³  íŠ¸ë ˆì´ì—ì„œë§Œ ì‹¤í–‰
  if (tray && process.platform === 'win32') {
    tray.displayBalloon({
      title: 'WebPrinter',
      content: 'ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.'
    });
  }
}